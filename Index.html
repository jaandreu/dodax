<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">

    <title>doooodax</title>
    <style>

      .base {
        display: none;
      }
      .section {
         padding: 0.5rem 0.0rem; 
      }
      @-webkit-keyframes spinAround{from{-webkit-transform:rotate(0);transform:rotate(0)}to{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}@keyframes spinAround{from{-webkit-transform:rotate(0);transform:rotate(0)}to{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}.pageloader{bottom:0;left:0;position:absolute;right:0;top:0}.pageloader{position:fixed;padding-top:2em;background:#00d1b2;background:#00d1b2;z-index:999998;transition:transform .35s ease-out,-webkit-transform .35s ease-out;will-change:transform}.pageloader.is-white{background-color:#fff;background:#fff}.pageloader.is-white::after{border-color:#0a0a0a;-webkit-animation:loader-figure-white 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-white 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-white .title{color:#0a0a0a}.pageloader.is-black{background-color:#0a0a0a;background:#0a0a0a}.pageloader.is-black::after{border-color:#fff;-webkit-animation:loader-figure-black 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-black 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-black .title{color:#fff}.pageloader.is-light{background-color:#f5f5f5;background:#f5f5f5}.pageloader.is-light::after{border-color:#363636;-webkit-animation:loader-figure-light 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-light 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-light .title{color:#363636}.pageloader.is-dark{background-color:#363636;background:#363636}.pageloader.is-dark::after{border-color:#f5f5f5;-webkit-animation:loader-figure-dark 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-dark 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-dark .title{color:#f5f5f5}.pageloader.is-primary{background-color:#00d1b2;background:#00d1b2}.pageloader.is-primary::after{border-color:#fff;-webkit-animation:loader-figure-primary 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-primary 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-primary .title{color:#fff}.pageloader.is-link{background-color:#3273dc;background:#3273dc}.pageloader.is-link::after{border-color:#fff;-webkit-animation:loader-figure-link 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-link 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-link .title{color:#fff}.pageloader.is-info{background-color:#209cee;background:#209cee}.pageloader.is-info::after{border-color:#fff;-webkit-animation:loader-figure-info 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-info 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-info .title{color:#fff}.pageloader.is-success{background-color:#23d160;background:#23d160}.pageloader.is-success::after{border-color:#fff;-webkit-animation:loader-figure-success 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-success 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-success .title{color:#fff}.pageloader.is-warning{background-color:#ffdd57;background:#ffdd57}.pageloader.is-warning::after{border-color:rgba(0,0,0,.7);-webkit-animation:loader-figure-warning 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-warning 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-warning .title{color:rgba(0,0,0,.7)}.pageloader.is-danger{background-color:#ff3860;background:#ff3860}.pageloader.is-danger::after{border-color:#fff;-webkit-animation:loader-figure-danger 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-danger 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-danger .title{color:#fff}.pageloader:not(.is-bottom-to-top){-webkit-transform:translateY(-100%);transform:translateY(-100%)}.pageloader.is-bottom-to-top{-webkit-transform:translateY(100%);transform:translateY(100%)}.pageloader.is-left-to-right{-webkit-transform:translateX(-100%);transform:translateX(-100%)}.pageloader.is-right-to-left{-webkit-transform:translateX(100%);transform:translateX(100%)}.pageloader.is-active:not(.is-left-to-right),.pageloader.is-active:not(.is-right-to-left){-webkit-transform:translateY(0);transform:translateY(0)}.pageloader.is-active.is-left-to-right,.pageloader.is-active.is-right-to-left{-webkit-transform:translateX(0);transform:translateX(0)}.pageloader::after{position:absolute;top:50%;left:50%;display:block;border-radius:100%;content:'';z-index:9999;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);width:0;height:0;box-sizing:border-box;border:0 solid #fff;-webkit-animation:loader-figure 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader .title{position:absolute;top:50%;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);margin:2em 0 0 0;font-size:.875em;letter-spacing:.1em;line-height:1.5em;color:#fff;white-space:nowrap}@-webkit-keyframes loader-figure{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-white{0%{height:0;width:0;background-color:#0a0a0a}29%{background-color:#0a0a0a}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-white{0%{height:0;width:0;background-color:#0a0a0a}29%{background-color:#0a0a0a}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-black{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-black{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-light{0%{height:0;width:0;background-color:#363636}29%{background-color:#363636}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-light{0%{height:0;width:0;background-color:#363636}29%{background-color:#363636}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-dark{0%{height:0;width:0;background-color:#f5f5f5}29%{background-color:#f5f5f5}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-dark{0%{height:0;width:0;background-color:#f5f5f5}29%{background-color:#f5f5f5}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-primary{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-primary{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-link{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-link{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-info{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-info{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-success{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-success{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-warning{0%{height:0;width:0;background-color:rgba(0,0,0,.7)}29%{background-color:rgba(0,0,0,.7)}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-warning{0%{height:0;width:0;background-color:rgba(0,0,0,.7)}29%{background-color:rgba(0,0,0,.7)}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-danger{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-danger{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}
      
      .pageloader{
        background-color: black;
        opacity: 70%;
      }
  
    </style>

</head>
<body>

  <div class="pageloader"><span class="title">Buscando...</span></div>

  <section class="section">
    <div class="container is-fluid">
      <div class="columns">
        <div class="column">
          <form id="formulario">
            <div class="field">
              <p class="control has-icons-left">
                <input class="input is-large is-info " id="search" type="text" placeholder="Qué buscamos?">
                <span class="icon is-left has-text-info	">
                  <i class="fas fa-search"></i>
                </span>
              </p>
            </div>
          </form>
      </div>
    </div>
    <div class="columns resultados is-multiline">
      <div class=" base column is-one-quarter">
        <div class="card">
          <div class="card-image">
            <figure class="image is-4by3">
              <img class="cover" src="" alt="Album cover">
            </figure>
          </div>
          <div class="card-content">
            <div class="media">
              <div class="media-content">
                <p class="album title is-4"></p>
                <p class="artist subtitle is-6"></p>
              </div>
            </div>
            <div class="content">
              <div class="table-container">
                <table class="table is-hoverable is-fullwidth">
                   <tbody>
                      <!-- Items con los precios-->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>       
      </div>
    </div>
  </div>
  </section>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script>
        
       const showSpinner = function (show) {
          if (show)
           $("div.pageloader").addClass("is-active");
          else
           $("div.pageloader").removeClass("is-active");
       }

        var urlsDodax = [
                  {text: "DE" , url: "https://www.dodax.de", params: "/de-de/search/?s="}
                  ,{text: "AT" , url: "https://www.dodax.at", params: "/de-at/search/?s=" }
                  ,{text: "FR" , url: "https://www.dodax.fr", params: "/fr-fr/search/?s="} 
                  ,{text: "UK" , url: "https://www.dodax.co.uk", params:"/en-gb/search/?s="} 
                  ,{text: "ES" , url: "https://www.dodax.es", params: "/es-es/search/?s="}
                  ,{text: "IT" , url: "https://www.dodax.it", params:"/it-it/search/?s="}
                  ,{text: "PL" , url: "https://www.dodax.pl", params: "/pl-pl/search/?s="} 
                  ,{text: "NL" , url: "https://www.dodax.nl", params: "/nl-nl/search/?s="} 
            ]

        //const proxyurl = "https://cors-anywhere.herokuapp.com/";
        const proxyurl = "https://dodax-proxy.herokuapp.com/";
        const ownerDocument = document.implementation.createHTMLDocument('virtual');

        const getCurrencyRates = async (url) => {

          let response = await fetch("https://api.exchangeratesapi.io/latest"); 
          let data = await response.json();
          return data;

        }

       

        //Devuelve la información de los albums de una url de Dodax.
        const getDodaxAlbums = async (url) => {

          console.log("Conectando:" + url);
          let response = await fetch(url); 
          let data = await response.text();
          return data;

        }
        const getPrice = function (price, codigo){
          if (rates != null){

            switch (codigo){
              case "UK":
                salida = (parseFloat(price.replace(",", ".")) * (1/rates.rates["GBP"])).toFixed(2);
                break;
              case "PL":
                salida = (parseFloat(price.replace(",", ".")) * (1/rates.rates["PLN"])).toFixed(2);
                break;
              default:
                salida = parseFloat(price.replace(",", ".")).toFixed(2);
            }
          }
          else{
            salida = parseFloat(price.replace(",", ".")).toFixed(2);
          }
          return salida;
        }

        const getCurrency = function(codigo){
          var salida = "€";
          switch (codigo){
            case "UK":
              salida = "£";
              break;
            case "PL":
              salida = "zł";
              break;
            default:
              salida = "€";

          }
          return salida;

        }

        //Invoca a todas las urls de Dodax al mismo tiempo para obtener su información.
        const getDodaxSitesAlbums = async(urls, cadenaBusqueda, items) => {
            
            const requests = urls.map((urlDodax) => {

                if (urlDodax.text === "ES")
                  cadenaBusqueda = cadenaBusqueda.toUpperCase().replace("VINYL", "VINILO");
                else
                  cadenaBusqueda = cadenaBusqueda.toUpperCase().replace("VINILO", "VINYL");

                const urlCompleta = proxyurl +  urlDodax.url + urlDodax.params + cadenaBusqueda + "&paginating=true&f=" + items;

                return getDodaxAlbums(urlCompleta)
                  .then((salida) => {

                    const $lineas = $(salida, ownerDocument).find("div.product");
                    urlDodax.html = $lineas;

                    return urlDodax;
                });
            })

            return Promise.all(requests)
        }
        var discos = []
        var rates = null;
        var limiteAlcanzado = false;

        const getAlbums = function(urlsDodax, cadenaBusqueda, items) {

          getDodaxSitesAlbums(urlsDodax, cadenaBusqueda, items)
            .then(content => {

                var nextUrlDodax = [];

                content.forEach(resultado => {

                  if (resultado.html.length == 12 && !limiteAlcanzado){
                        nextUrlDodax.push(resultado);
                  }

                  resultado.html.each(function() {

                        var obj = {};
                        var idAlbum = $(this).find('a.js-product').attr('id');

                        var encontrado = false;
                        var indexEncontrado = -1;
                       
                        $.each(discos, function(index,value){
                            if (value.id == idAlbum){
                               indexEncontrado = index;
                               encontrado = true;
                               return false;
                            }
                        });

                        var precio = $(this).find('a.buy-button span').text()
                                        .replace("€", "")
                                        .replace("£", "")
                                        .replace("zł", "")
                                        .replace(".", ",");

                        var precioObj = {
                            url: resultado.url + $(this).find('a.js-product').attr('href')
                           ,price: getPrice(precio, resultado.text)
                           ,priceInt: getPrice(precio, resultado.text)
                           ,currency: "€"
                           ,text: resultado.text
                        };

                        if (encontrado){
                          discos[indexEncontrado].prices.push(precioObj);

                          if (parseFloat(discos[indexEncontrado].minPrice) > parseFloat(precioObj.priceInt)){
                            discos[indexEncontrado].minPrice = precioObj.priceInt;
                          }

                        }
                        else{

                          obj.id = idAlbum;
                          obj.image = $(this).find('img').attr('src');
                          obj.title = $(this).find('p.product_title').text();
                          obj.from = $(this).find('p.product_from').text();
                          obj.type = $(this).find('p.product_type').text();
                          obj.prices = []
                          obj.prices.push(precioObj)
                          obj.minPrice = precioObj.priceInt;
                          discos.push(obj);
                        
                        }
                  });
                 
                });

                limiteAlcanzado = discos.length > 100;

                if (nextUrlDodax.length > 0 && false){
                  getAlbums(nextUrlDodax, cadenaBusqueda, items + 12);
                }
                else {
                  if (discos.length == 0)
                    $("div.noresult").show();
                  else {
                    $("div.noresult").hide();
                    debugger;
                    $.each(discos, function(index, value){
                        var $base = $(".base").clone().removeClass("base").addClass("resultados-items");
                              $base.find("p.album").html("<span style='padding-right:4px;'>" + value.title + "</span>" + (value.type !== "" ? "<span class='tag is-info is-rounded'>"+ value.type + "</span>" : ""));
                              $base.find("p.artist").text(value.from);
                              $base.find("img.cover").attr("src", value.image);
                              $.each(value.prices, function(index, value2){
                                $base.find("table tbody").append("<tr><td>" + value2.text + "</td><td><a target='_blank' href='"+ value2.url + "'>" + value2.price + " " + value2.currency + "</a></td><td>"+ (value2.priceInt === value.minPrice ? "<i class='fas fa-star has-text-info	'></i>": "") +"</td></div>");
                              });
                              $(".resultados").append($base);
                    });
                  }
                  showSpinner(false);             
                }

            });
        }

        $( document ).ready(function() {

          getCurrencyRates()
          .then((salida) => {
             rates = salida;
          });
        });

        $("#formulario").submit(function( event ) {

            var cadenaBusqueda = $("#search").val().replace(/ /g, '+');

            //Como mínimo 6 caracteres de búsqueda.
            if (cadenaBusqueda.length < 1)
              return false;

            showSpinner(true);
            $(".resultados").hide();
            $(".resultados-items").remove();
            discos = [];
            limiteAlcanzado = false;
            getAlbums(urlsDodax, cadenaBusqueda, 0);
    
            $(".resultados").show();
            event.preventDefault();
        });

    </script>
</body>
