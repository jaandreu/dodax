<!doctype html>
<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">

    <link  rel="icon"   href="favicon.ico"/>
    <title>XADOD</title>
    <style>

      html {
        background-color: hsl(201, 29%, 88%);
      }

      .base {
        display: none;
      }

      @-webkit-keyframes spinAround{from{-webkit-transform:rotate(0);transform:rotate(0)}to{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}@keyframes spinAround{from{-webkit-transform:rotate(0);transform:rotate(0)}to{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}.pageloader{bottom:0;left:0;position:absolute;right:0;top:0}.pageloader{position:fixed;padding-top:2em;background:#00d1b2;background:#00d1b2;z-index:999998;transition:transform .35s ease-out,-webkit-transform .35s ease-out;will-change:transform}.pageloader.is-white{background-color:#fff;background:#fff}.pageloader.is-white::after{border-color:#0a0a0a;-webkit-animation:loader-figure-white 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-white 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-white .title{color:#0a0a0a}.pageloader.is-black{background-color:#0a0a0a;background:#0a0a0a}.pageloader.is-black::after{border-color:#fff;-webkit-animation:loader-figure-black 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-black 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-black .title{color:#fff}.pageloader.is-light{background-color:#f5f5f5;background:#f5f5f5}.pageloader.is-light::after{border-color:#363636;-webkit-animation:loader-figure-light 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-light 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-light .title{color:#363636}.pageloader.is-dark{background-color:#363636;background:#363636}.pageloader.is-dark::after{border-color:#f5f5f5;-webkit-animation:loader-figure-dark 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-dark 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-dark .title{color:#f5f5f5}.pageloader.is-primary{background-color:#00d1b2;background:#00d1b2}.pageloader.is-primary::after{border-color:#fff;-webkit-animation:loader-figure-primary 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-primary 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-primary .title{color:#fff}.pageloader.is-link{background-color:#3273dc;background:#3273dc}.pageloader.is-link::after{border-color:#fff;-webkit-animation:loader-figure-link 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-link 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-link .title{color:#fff}.pageloader.is-info{background-color:#209cee;background:#209cee}.pageloader.is-info::after{border-color:#fff;-webkit-animation:loader-figure-info 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-info 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-info .title{color:#fff}.pageloader.is-success{background-color:#23d160;background:#23d160}.pageloader.is-success::after{border-color:#fff;-webkit-animation:loader-figure-success 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-success 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-success .title{color:#fff}.pageloader.is-warning{background-color:#ffdd57;background:#ffdd57}.pageloader.is-warning::after{border-color:rgba(0,0,0,.7);-webkit-animation:loader-figure-warning 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-warning 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-warning .title{color:rgba(0,0,0,.7)}.pageloader.is-danger{background-color:#ff3860;background:#ff3860}.pageloader.is-danger::after{border-color:#fff;-webkit-animation:loader-figure-danger 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure-danger 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader.is-danger .title{color:#fff}.pageloader:not(.is-bottom-to-top){-webkit-transform:translateY(-100%);transform:translateY(-100%)}.pageloader.is-bottom-to-top{-webkit-transform:translateY(100%);transform:translateY(100%)}.pageloader.is-left-to-right{-webkit-transform:translateX(-100%);transform:translateX(-100%)}.pageloader.is-right-to-left{-webkit-transform:translateX(100%);transform:translateX(100%)}.pageloader.is-active:not(.is-left-to-right),.pageloader.is-active:not(.is-right-to-left){-webkit-transform:translateY(0);transform:translateY(0)}.pageloader.is-active.is-left-to-right,.pageloader.is-active.is-right-to-left{-webkit-transform:translateX(0);transform:translateX(0)}.pageloader::after{position:absolute;top:50%;left:50%;display:block;border-radius:100%;content:'';z-index:9999;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);width:0;height:0;box-sizing:border-box;border:0 solid #fff;-webkit-animation:loader-figure 1.15s infinite cubic-bezier(.215,.61,.355,1);animation:loader-figure 1.15s infinite cubic-bezier(.215,.61,.355,1)}.pageloader .title{position:absolute;top:50%;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);margin:2em 0 0 0;font-size:.875em;letter-spacing:.1em;line-height:1.5em;color:#fff;white-space:nowrap}@-webkit-keyframes loader-figure{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-white{0%{height:0;width:0;background-color:#0a0a0a}29%{background-color:#0a0a0a}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-white{0%{height:0;width:0;background-color:#0a0a0a}29%{background-color:#0a0a0a}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-black{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-black{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-light{0%{height:0;width:0;background-color:#363636}29%{background-color:#363636}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-light{0%{height:0;width:0;background-color:#363636}29%{background-color:#363636}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-dark{0%{height:0;width:0;background-color:#f5f5f5}29%{background-color:#f5f5f5}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-dark{0%{height:0;width:0;background-color:#f5f5f5}29%{background-color:#f5f5f5}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-primary{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-primary{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-link{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-link{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-info{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-info{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-success{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-success{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-warning{0%{height:0;width:0;background-color:rgba(0,0,0,.7)}29%{background-color:rgba(0,0,0,.7)}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-warning{0%{height:0;width:0;background-color:rgba(0,0,0,.7)}29%{background-color:rgba(0,0,0,.7)}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@-webkit-keyframes loader-figure-danger{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}@keyframes loader-figure-danger{0%{height:0;width:0;background-color:#fff}29%{background-color:#fff}30%{height:2em;width:2em;background-color:transparent;border-width:1em;opacity:1}100%{height:2em;width:2em;border-width:0;opacity:0;background-color:transparent}}
      
      .pageloader{
        background-color: black;
        opacity: 70%;
      }
      div.navbar-menu {
        background-color: hsl(198, 100%, 21%);
      }
      span.actions  {
        vertical-align: middle;
        padding-left: 2px;
      }
      
      .flexgrow {
        flex-grow: 1;
      }
      .naranja {
        color: hsl(93, 67%, 38%);
      }

      .update {
        color: hsl(93, 67%, 38%);
      }

      .button.is-green {
         background-color: hsl(93, 67%, 38%);
         border-color: transparent;
         color: #fff;
      }
      tr.best-price {
        background-color:hsl(282, 100%, 95%);
      }
    </style>

</head>
<body class="has-navbar-fixed-top">

  <!--Navbar (buscador)-->
  <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
    <div class="navbar-menu is-active">
      <div class="navbar-start flexgrow">
        <div class="navbar-item flexgrow">
          <div class="container">
            <div class="columns">
              <div class="column">
                <form id="formulario" method='GET' action='javascript:void(0); return false;'>
                  <div class="field has-addons">
                    <div class="control flexgrow">
                      <input class="input is-large is-info is-expanded" id="search" type="text"
                        placeholder="last shadow puppets ..." style="text-transform:uppercase">
                    </div>
                    <div class="control">
                      <button type="submit" class="button is-green is-large"> <i class="fas fa-search"></i></button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Loading -->
  <div id="div-pageloader" class="pageloader"><span class="title">Buscando...</span></div>

  <section class="section">

    <!-- Container para las fichas de resultados.-->
    <div class="container">
   
      <!-- Resultados -->
      <div id="div-resultados" class="columns resultados is-multiline">
        <div id="div-base" class=" base column is-one-quarter is-half-tablet">
          <div class="card">
            <div class="card-image">
              <figure class="image is-4by3">
                <img  id="img-cover" class="cover" src="" alt="Album cover">
              </figure>
            </div>
            <div class="card-content">
              <div class="media">
                <div class="media-content">
                  <p id="p-album" class="album title is-4"></p>
                  <p id="p-artist" class="artist subtitle is-6"></p>
                </div>
              </div>
              <div class="content">
                <div class="table-container">
                  <table id="table-precios"  class="table is-hoverable is-fullwidth">
                    <tbody id="table-precios-body">
                      <!-- Items con los precios-->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!--Mensaje para no se han encontrado datos-->
      <div style="display:none" id="div-error" class="notification is-danger">
        Ha fallado la conexión con alguno de los servidores, repita la búsqueda
      </div>

      <!-- Botón para obtener más resultados.-->
      <div id="div-button-more" style="display: none" class="columns">
        <div class="column">
            <button id="button-more" class="button is-info is-fullwidth is-outlined">
              <span class="icon is-small">
                <i class="fas fa-caret-down"></i>
              </span>
              <span>Más resultados</span>
            </button>
        </div>
      </div>
        
      <!-- Cuadro de ayuda-->
      <article id="div-info" class="message is-info">
        <div class="message-header">
          <p>Ayuda</p>
        </div>
        <div class="message-body">
          <ul>
            <li>- <b>Búsqueda en la sección de vinilos:</b> no hace falta poner <b>VINILO</b>, <b>VINYL</b> ni <b>LP</b>.</li>
            <li>- <b>Criterios de búsqueda:</b> artista/album, id dodax/codigo de barras, label, cualquier cosa que funcione en dodax aquí funcionará <b>;-).</b></li>
            <li>- <b>Ficha:</b> podemos acceder a Dodax clicando en el importe, podemos acceder a Discogs clicando en el icono del vinilo.</li>
            <li>- <b>El icono de la estrella representa los mejores precios.</b></li>
            <li>- <b>Cambio de moneda:</b> para el cambio de moneda se usan los datos oficiales en el momento de la consulta, aunque servicios como Paypal suelen aplicar otros tipos de cambio.</li>
            <li>- <b>Sugerencias:</b> cualquier sugerencia de cambio la podéir reportar en el grupo de Facebook <b><a href="https://www.facebook.com/groups/307523296709864">Ofertas de Vinilos en amazon, dodax, etc...sin censuras todos los estilos</a></b></li>
          </ul>
        </div>
      </article>

      <!--Mensaje para no se han encontrado datos-->
      <div style="display: none;" id="div-noresult" class="noresult notification is-info">
        No se han encontrado coincidencias
      </div>

    </div>

  </section>

  <script defer src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>
  
  <script>

    //Método que muestra u oculta el frame de buscando.
    const showSpinner = function (show) {

      if (show)
        addClass("div-pageloader", "is-active");  
      else
        removeClass("div-pageloader", "is-active");  

    }

    //Listado de servidores a los que consultaremos.
    var urlsDodax = [
    {
      text: "DE",
      url: "https://www.dodax.de",
      params: "/de-de/musik-cds-dvds-vinyl-cLOFV6FFU7H-f-lpvinyl-K6IQQ1BLV9/?s="
     }
     , {
      text: "AT",
      url: "https://www.dodax.at",
      params: "/de-at/musik-cds-dvds-vinyl-cLOFV6FFU7H-f-lpvinyl-K6IQQ1BLV9/?s="
    }
    , {
      text: "FR",
      url: "https://www.dodax.fr",
      params: "/fr-fr/musik-cds-dvds-vinyl-cLOFV6FFU7H-f-lpvinyl-K6IQQ1BLV9/?s="
    }
    , {
      text: "UK",
      url: "https://www.dodax.co.uk",
      params: "/en-gb/musik-cds-dvds-vinyl-cLOFV6FFU7H-f-lpvinyl-K6IQQ1BLV9/?s="
    }
    , {
      text: "ES",
      url: "https://www.dodax.es",
      params: "/es-es/musik-cds-dvds-vinyl-cLOFV6FFU7H-f-lpvinyl-K6IQQ1BLV9/?s="
    }
    , {
      text: "IT",
      url: "https://www.dodax.it",
      params: "/it-it/musik-cds-dvds-vinyl-cLOFV6FFU7H-f-lpvinyl-K6IQQ1BLV9/?s="
    }
    , {
      text: "PL",
      url: "https://www.dodax.pl",
      params: "/pl-pl/musik-cds-dvds-vinyl-cLOFV6FFU7H-f-lpvinyl-K6IQQ1BLV9/?s="
    }
    , {
      text: "NL",
      url: "https://www.dodax.nl",
      params: "/nl-nl/musik-cds-dvds-vinyl-cLOFV6FFU7H-f-lpvinyl-K6IQQ1BLV9/?s="
    }
    ]

    //Proxy para evitar el CORS
    const proxyurl = window.location.host.includes('netlify') ? "https://dodax-proxy.herokuapp.com/" : "https://cors-anywhere.herokuapp.com/";

    //Funciones auxiliares DOM
    const showElement = function(idElement){
       var elem = document.getElementById(idElement);
       if (elem != null) {
         elem.style.display = "";
       }
    }

    const hideElement = function(idElement){
       var elem = document.getElementById(idElement);
       if (elem != null) {
         elem.style.display = "none";
       }
    }

    const addClass = function(idElement, className){
       var elem = document.getElementById(idElement);
       if (elem != null) {
        elem.classList.add(className)
       }
    }

    const removeClass = function(idElement, className){
       var elem = document.getElementById(idElement);
       if (elem != null) {
        elem.classList.remove(className)
       }
    }

    //Obtiene un JSON con los rates de las monedas en base al EUR.
    const getCurrencyRates = async (url) => {

        let response = await fetch("https://api.exchangeratesapi.io/latest");
        let data = await response.json();
        return data;
    }

    //Obtiene un importe en euros.
    const getPrice = function (price, codigo) {
      if (rates != null) {

        switch (codigo) {
          case "UK":
            salida = (parseFloat(price.replace(",", ".")) * (1 / rates.rates["GBP"])).toFixed(2);
            break;
          case "PL":
            salida = (parseFloat(price.replace(",", ".")) * (1 / rates.rates["PLN"])).toFixed(2);
            break;
          default:
            salida = parseFloat(price.replace(",", ".")).toFixed(2);
        }
      } else {
        salida = parseFloat(price.replace(",", ".")).toFixed(2);
      }
      return salida;
    }

    //Obtiene el caracter de moneda en función del código de pais.
    const getCurrency = function (price, codigo) {
      var salida = "";
      switch (codigo) {
        case "UK":
          salida = price + " £";
          break;
        case "PL":
          salida = price + " zł";
          break;
        default:
          salida = "";

      }
      return salida;
    }
  
    //Devuelve la información de los albums de una url de Dodax.
    const getDodaxAlbums = async (url) => {

      console.log("Conectando:" + url);
      let response = await fetch(url);
      let data = await response.text()

      return {
           status: response.status
          ,data: data
      };

    }
    const updateAlbum = function(idAlbum) {

      showSpinner(true);
      getAlbums(idAlbum, 0, false, true)
      console.log(event);

    };

    const updateBestsPrices = function(idAlbum, minPrice){

       var fichaAlbum = document.getElementById(idAlbum);

       Array.from(fichaAlbum.getElementsByClassName('tr-albumprice')).forEach(tr => {
          if (tr.getAttribute('price-int') === minPrice){
              tr.classList.add('best-price');
              (tr.getElementsByClassName("td-albumminprice")[0]).innerHTML = "<i class='fas fa-star has-text-info''></i>";
          }
          else{
            tr.classList.remove('best-price');
            (tr.getElementsByClassName("td-albumminprice")[0]).innerHTML = "";
          }
          
       });

    }

    const setHTMLPrice = function(idAlbum, price, gtin){
        
         var ficha = document.getElementById(idAlbum);
         var minPrice = parseFloat(ficha.getAttribute('min-price'));
         var gtinFicha = ficha.getAttribute("gtin-ficha");

         if (gtinFicha === "" && gtin != ""){
           ficha.setAttribute("gtin-ficha", gtin);
           (ficha.getElementsByClassName("discogs")[0]).innerHTML = "<a href='https://www.discogs.com/search/?q=" + gtin +"&type=all'><i class='naranja fas fa-record-vinyl'></i></a>";
         }

         var idPrecio = price.text + "-" + idAlbum;
         var trElement = document.getElementById(idPrecio);
         trElement.setAttribute('price-int', price.priceInt);
         trElement.classList.add('tr-albumprice');

         document.getElementById(idPrecio + "-PRICE").innerHTML = "<a href='" + price.url + "'>" + price.price + " " + price.currency + "</a>"
         document.getElementById(idPrecio + "-ORIGINALPRICE").innerText = price.priceOriginal;

         if (parseFloat(minPrice) >= parseFloat(price.priceInt)) {
             ficha.setAttribute("min-price", price.priceInt);
             updateBestsPrices(idAlbum, price.priceInt);
         }

    }

    //Establece el HTML de un disco completo.
    const setHTMLAlbum = function(disco){

      var parser = new DOMParser();
      var base = parser.parseFromString(document.getElementById("div-base").outerHTML, "text/html");

      base.getElementById("div-base").setAttribute("id", disco.id);
      base.getElementById(disco.id).classList.remove('base');
      base.getElementById(disco.id).classList.add("resultados-items");
      base.getElementById(disco.id).setAttribute("min-price",disco.price.priceInt);
      base.getElementById(disco.id).setAttribute("gtin-ficha", disco.gtin);

      base.getElementById("p-album").innerHTML = 
          "<span style='padding-right:4px;'>" + disco.title + "</span>" 
        + (disco.type !== "" ? "<span class='tag is-info is-rounded'>" + disco.type + "</span>" : "")
        + (disco.gtin !== "" ? "<span class='actions discogs'><a href='https://www.discogs.com/search/?q=" + disco.gtin +"&type=all'><i class='naranja fas fa-record-vinyl'></i></a></span>" : "<span class='actions discogs'></span>")
        + "<span class='actions span-update'><a id='update-album' onclick='updateAlbum(\""+ disco.id + "\")' href='javascript:void(0);'><i class='update fas fa-sync-alt'></i></a></span>";

      base.getElementById("p-artist").innerText = disco.from;
      base.getElementById("img-cover").setAttribute("src", disco.image);

      urlsDodax.forEach(url => {

        var idPrecio = url.text + "-" + disco.id;
        var trElement = document.createElement("tr");
        trElement.setAttribute("id", idPrecio);

        trElement.innerHTML = "<td>" + url.text + "</td>" 
                            + "<td id='" + idPrecio + "-PRICE'>--</td>"
                            + "<td id='" + idPrecio + "-ORIGINALPRICE'></td>"
                            + "<td class='td-albumminprice' id='" + idPrecio + "-MINPRICE'></td>";

        base.getElementById("table-precios-body").appendChild(trElement);

      })

      document.getElementById("div-resultados").appendChild(base.getElementById(disco.id));
      setHTMLPrice(disco.id, disco.price, disco.gtin);
    }

    //Invoca a todas las urls de Dodax al mismo tiempo para obtener su información.
    const getDodaxSitesAlbums = async (cadenaBusqueda, items) => {

      const requests = urlsDodax.map((urlDodax) => {

     const urlCompleta = proxyurl + urlDodax.url + urlDodax.params + cadenaBusqueda + "&paginating=true&f=" + items;

        return getDodaxAlbums(urlCompleta)
          .then((salida) => {

              var parser = new DOMParser();
              var doc = parser.parseFromString(salida.data, "text/html");
              var nextUrlElement = doc.getElementsByClassName('related_list')[0];

              return {

                  url : urlDodax.url
                 ,params: urlDodax.params
                 ,text: urlDodax.text
                 ,listaAlbums: doc.getElementsByClassName('product')
                 ,nextUrl: nextUrlElement != null ? nextUrlElement.getAttribute('data-scroller-next-url') : null
                 ,error: (salida.status !== 200 ? salida.data : "")

              };

          });
      })

      return Promise.all(requests)
    }

    //Variables globales.
    var rates = null;

    //Obtiene los albums que coinciden con la cadena de búsqueda, a partir de n items (es paginado.)
    const getAlbums = function (cadenaBusqueda, items, firstCall, updateAlbum) {

      getDodaxSitesAlbums(cadenaBusqueda, items)
        .then(content => {

          var hayResultados = false;
          var mostrarMasResultados = false;

          content.forEach(resultado => {

            //Si ha habido un error mostramos el mensaje pero procesamos la respuesta.
            if (resultado.error !== ""){
              console.log(resultado.error);
              showElement("div-error");
            }
            
            if (resultado.nextUrl != null) {
              mostrarMasResultados = true;
            }

            Array.from(resultado.listaAlbums).forEach(album => {

               hayResultados = true;

               //Identificador del album
               var idAlbum = (album.getElementsByClassName('js-product')[0]).getAttribute('id');
               //Precio del disco.
               var precio = ((album.getElementsByClassName('buy-button')[0]).getElementsByTagName('span')[0]).innerText
                 .replace("€", "")
                 .replace("£", "")
                 .replace("zł", "")
                 .replace(".", ",")
                 .replace(" ", "")
                 .replace(String.fromCharCode(160), "")
                 .replace("&nbsp;", "");

               //Código de barras.
               var gtin =  (album.getElementsByClassName('buy-button')[0]).getAttribute('onmousedown');
               gtin = (gtin !== null) ? gtin.replace("RetailRocket.addToCartRetailRocket('", "").replace("');", "") : "";

               //Url del detalle del disco.
               var urlRelativa = (album.getElementsByClassName('js-product')[0]).getAttribute('href');
               //Existe ya la ficha?
               var encontrado = document.getElementById(idAlbum) != null;
               //Datos del precio.
               var precioObj = {
                 url: resultado.url + urlRelativa,
                 price: getPrice(precio, resultado.text).replace(".", ","),
                 priceInt: getPrice(precio, resultado.text),
                 priceOriginal: getCurrency(precio, resultado.text),
                 currency: "€",
                 text: resultado.text,
               };

              if (encontrado) {
                setHTMLPrice(idAlbum, precioObj, gtin)
              } else {

                //El disco no está cargado en la página.  
                var obj = {};
                obj.id = idAlbum;
                obj.image =  (album.getElementsByTagName('img')[0]).getAttribute('src');
                obj.title = (album.getElementsByClassName('product_title')[0]).innerText;
                obj.from = (album.getElementsByClassName('product_from')[0]).innerText;
                obj.type = (album.getElementsByClassName('product_type')[0]).innerText;
                obj.price = precioObj;
                obj.minPrice = precioObj.priceInt;
                obj.gtin = gtin;

                setHTMLAlbum(obj);

              }

            });

          });

          if (firstCall && !hayResultados){
            showElement("div-noresult");
          }

          if (!updateAlbum){
  
            if (mostrarMasResultados){
              showElement("div-button-more");
              sessionStorage.setItem("moreItems", "1");
            }
            else{
              hideElement("div-button-more");
              sessionStorage.setItem("moreItems", "0");
            }
  
            var htmlToSave = document.getElementById("div-resultados").innerHTML;
            sessionStorage.setItem('lastSearchResult', htmlToSave);

          }

          showSpinner(false);

        });

    }

    document.addEventListener("DOMContentLoaded", function(event) { 

      getCurrencyRates()
        .then((salida) => {
          rates = salida;
        });

      //última búsqueda
      var lastSearchResult = sessionStorage.getItem('lastSearchResult');
      var lastSearch = sessionStorage.getItem('lastSearch');

      if (lastSearchResult != null){
        document.getElementById("div-resultados").innerHTML = lastSearchResult;
        document.getElementById("search").value = lastSearch;
        hideElement("div-info")
        if (sessionStorage.getItem("moreItems") === "1"){
            showElement("div-button-more");
        }
    
      }

    });

    document.getElementById("button-more").addEventListener('click', function(){

        showSpinner(true);
        var itemsActual = parseInt(sessionStorage.getItem("lastSearchIndex")) + 12;
        var cadenaBusquedaActual = sessionStorage.getItem("lastSearch");
        getAlbums(cadenaBusquedaActual, itemsActual, false, false);
        sessionStorage.setItem("lastSearchIndex", itemsActual)

    });
    
    document.getElementById("formulario").addEventListener('submit', function(){

      cadenaBusqueda = document.getElementById("search").value
                          .toUpperCase()
                          .replace("VINILO", "")
                          .replace("VINYL", "")
                          .replace(" CD", "")
                          .replace(" LP","")
                          .replace("CD ", "")
                          .replace("LP ","")
                          .trim()
                          .replace(/ /g, '+');

      //Como mínimo 6 caracteres de búsqueda.
      if (cadenaBusqueda.length < 2)
        return false;

      sessionStorage.setItem('lastSearch', cadenaBusqueda);

      showSpinner(true);

      hideElement("div-info")
      hideElement("div-error")
      hideElement("div-noresult");
      hideElement("div-resultados");
      hideElement("div-button-more");

      Array.from(document.getElementsByClassName("resultados-items")).forEach(element => {
          element.parentNode.removeChild(element);
      });

      sessionStorage.setItem("lastSearchIndex", "0");
      getAlbums(cadenaBusqueda, 0, true, false);
      showElement("div-resultados");

      event.preventDefault();

    });

  </script>

</body>
</html>